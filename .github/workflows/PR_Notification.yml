name: PR Notification to Slack

on:
  pull_request:
    types: [opened, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Send notification to Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_CREATE_WEBHOOK_URL }}
        SLACK_IDS: ${{ secrets.SLACK_IDS }}
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"

        REVIEWERS=$(echo '${{ toJson(github.event.pull_request.requested_reviewers) }}' | jq -r '.[].login')
        SLACK_IDS_STRING=$(echo $SLACK_IDS | tr ',' '\n' | awk -F= '{print "\"" $1 "\": \"" $2 "\""}' | jq -s 'add')

        SLACK_IDS=""
        for reviewer in $REVIEWERS; do
          # 대소문자를 구분하여 리뷰어 로그인 이름으로 Slack ID 찾기
          SLACK_ID=$(echo "$SLACK_IDS_STRING" | jq -r --arg reviewer "$reviewer" '.[$reviewer]')
          
          if [ "$SLACK_ID" != "null" ]; then
            SLACK_IDS="${SLACK_IDS}, <@${SLACK_ID}>"
          else
            SLACK_IDS="${SLACK_IDS}, @unknown"
          fi
        done
        SLACK_IDS=${SLACK_IDS:2}

        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "🔥 '"${PR_TITLE}"'( <'"${PR_URL}"'> ) 에 대한 pull request가 생성되었습니다.\n'"${SLACK_IDS}"'의 리뷰를 기다리고 있어요!"
        }' $SLACK_WEBHOOK_URL
