name: PR Slack Notification
on:
  pull_request:
    types: [opened]

jobs:
  slack-notification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get reviewers
        id: get-reviewers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        run: |
          declare -A reviewer_map
          IFS=$'\n'
          for entry in $(echo '${{ secrets.SLACK_IDS }}' | jq -r 'to_entries | map("\(.key)=\(.value)") | .[]'); do
            key=${entry%%=*}
            value=${entry#*=}
            reviewer_map["$key"]="$value"
          done

          reviewers=""
          for reviewer in $(gh pr view ${{ github.event.pull_request.number }} --json reviews --jq '.reviews[].author.login'); do
            if [[ -n "${reviewer_map[$reviewer]}" ]]; then
              reviewers+="<@${reviewer_map[$reviewer]}>,"
            fi
          done
          reviewers=${reviewers%,}
          echo "::set-output name=reviewers::$reviewers"
          echo "!!Reviewers: $reviewers"

      - name: Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ”¥ *${{ github.event.pull_request.title }}ì— ëŒ€í•œ <${{ github.event.pull_request.html_url }}| pull request>ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.* ğŸ”¥"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.get-reviewers.outputs.reviewers }}ì˜ ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!"
                  }
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_HUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_CREATE_WEBHOOK_URL }}
