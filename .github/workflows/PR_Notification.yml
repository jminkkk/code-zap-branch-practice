name: PR Notification to Slack
on:
  pull_request:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Send notification to Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_CREATE_WEBHOOK_URL }}
        SLACK_IDS_JSON: ${{ secrets.SLACK_IDS }}
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        REVIEWERS=$(echo "${{ github.event.pull_request.requested_reviewers }}" | jq -r '.[].login')

        SLACK_IDS_MAPPING=$(echo "$SLACK_IDS_JSON" | jq -r 'to_entries | map({(.key): .value}) | add')
        
        reviewers_string=""
        for reviewer in $(echo "$REVIEWERS" | jq -r '.[]'); do
          SLACK_ID=$(echo "$SLACK_IDS_MAPPING" | jq -r --arg key "$reviewer" '.[$key]')
          if [[ -n "$SLACK_ID" ]]; then
            reviewers_string+="<@$SLACK_ID> "
          fi
        done
        
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "🔥 '"${PR_TITLE}"'( <'"${PR_URL}"'> ) 에 대한 pull request가 생성되었습니다.\n'"${reviewers_string}"'의 리뷰를 기다리고 있어요!"
        }' $SLACK_WEBHOOK_URL
