name: PR Notification to Slack

on:
  pull_request:
    types: [opened, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Send notification to Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_CREATE_WEBHOOK_URL }}
        SLACK_IDS: ${{ secrets.SLACK_IDS }}
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"

        REVIEWERS=$(echo '${{ toJson(github.event.pull_request.requested_reviewers) }}' | jq -r '.[].login')
        SLACK_IDS_STRING=$(echo $SLACK_IDS | tr ',' '\n' | awk -F= '{print "\"" $1 "\": \"" $2 "\""}' | jq -s 'add')

        SLACK_IDS=""
        for reviewer in $REVIEWERS; do
          # ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„í•˜ì—¬ ë¦¬ë·°ì–´ ë¡œê·¸ì¸ ì´ë¦„ìœ¼ë¡œ Slack ID ì°¾ê¸°
          SLACK_ID=$(echo "$SLACK_IDS_STRING" | jq -r --arg reviewer "$reviewer" '.[$reviewer]')
          
          if [ "$SLACK_ID" != "null" ]; then
            SLACK_IDS="${SLACK_IDS}, <@${SLACK_ID}>"
          else
            SLACK_IDS="${SLACK_IDS}, @unknown"
          fi
        done
        SLACK_IDS=${SLACK_IDS:2}

        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "ğŸ”¥ '"${PR_TITLE}"'( <'"${PR_URL}"'> ) ì— ëŒ€í•œ pull requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n'"${SLACK_IDS}"'ì˜ ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!"
        }' $SLACK_WEBHOOK_URL
