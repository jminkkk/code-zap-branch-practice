name: PR Notification to Slack

on:
  pull_request:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Send notification to Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_CREATE_WEBHOOK_URL }}
        SLACK_IDS_JSON: ${{ secrets.SLACK_IDS }}
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        REVIEWERS=$(echo "${{ github.event.pull_request.requested_reviewers }}" | jq -r '.[].login')
        echo REVIEWERS

        SLACK_IDS_MAPPING=$(echo "$SLACK_IDS_JSON" | jq -r 'to_entries | map({(.key | ascii_downcase): .value}) | add')

        SLACK_IDS=""
        for reviewer in $REVIEWERS; do
          SLACK_ID=$(echo $SLACK_IDS_MAPPING | jq -r --arg reviewer "$reviewer" '.[$reviewer | ascii_downcase]')
          if [ "$SLACK_ID" != "null" ]; then
            SLACK_IDS="${SLACK_IDS}, <@${SLACK_ID}>"
            echo SLACK_IDS
          else
            SLACK_IDS="${SLACK_IDS}, @unknown"
          fi
        done
        echo SLACK_IDS
        SLACK_IDS=${SLACK_IDS:2} # Remove leading comma and space

        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "üî• '"${PR_TITLE}"'( <'"${PR_URL}"'> ) Ïóê ÎåÄÌïú pull requestÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.\n'"${SLACK_IDS}"'Ïùò Î¶¨Î∑∞Î•º Í∏∞Îã§Î¶¨Í≥† ÏûàÏñ¥Ïöî!"
        }' $SLACK_WEBHOOK_URL
