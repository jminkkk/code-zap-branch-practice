name: PR Slack Notification

on:
  pull_request:
    types: [opened, reopened]

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Slack 알람 보내기
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_CREATE_WEBHOOK_URL }}
        TEAM_MAPPING: ${{ secrets.SLACK_IDS }}
        github-token: ${{secrets.GITHUB_TOKEN}}
      run: |
        pr_title="${{ github.event.pull_request.title }}"
        pr_url="${{ github.event.pull_request.html_url }}"
        reviewers=$(echo "${{ github.event.pull_request.requested_reviewers }}" | jq -r '.[].login')
        
        team_mapping=$(echo $TEAM_MAPPING | jq -r '.')
        echo "Reviewers: $reviewers"
        
        mentions=""
        for reviewer in $reviewers; do
          slack_id=$(echo $team_mapping | jq -r --arg gh "$reviewer" '.[$gh]')
          echo "!reviewer: $reviewer"
          if [ "$slack_id" != "null" ]; then
            mentions="$mentions <@$slack_id>"
          fi
        done
        echo "mentions: $mentions"

        if [ ! -z "$mentions" ]; then
          message="$mentions 님, 새로운 PR이 생성되었습니다: <$pr_url|$pr_title>"
          curl -X POST -H 'Content-type: application/json' --data '{"text":"$mentions"}' \
          ${{ secrets.SLACK_PR_CREATE_WEBHOOK_URL }}
        echo "message: $message"
        fi
